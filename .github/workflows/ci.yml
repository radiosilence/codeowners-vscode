name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
      - run: npm ci
      - run: npm run lint
      - run: npm run compile

  # Check if version changed (only on main)
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [check]
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if version needs release
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT"

          # Get latest release version from GitHub
          RELEASED=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null | sed 's/^v//' || echo "0.0.0")
          echo "Latest released version: $RELEASED"

          if [ "$CURRENT" != "$RELEASED" ]; then
            echo "New version to release!"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
          else
            echo "Version already released"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # Package and publish (only if version changed)
  publish:
    name: Publish
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - run: npm ci
      - run: npm run compile

      - name: Package extension
        run: npx @vscode/vsce package

      - name: Publish to Marketplace
        run: npx @vscode/vsce publish -p ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX
        run: npx ovsx publish *.vsix -p ${{ secrets.OVSX_PAT }}
        continue-on-error: true

      - name: Delete existing release and tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ needs.check-version.outputs.version }}"
          gh release delete "$VERSION" --yes 2>/dev/null || true
          git push origin ":refs/tags/$VERSION" 2>/dev/null || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: v${{ needs.check-version.outputs.version }}
          draft: false
          prerelease: false
          files: "*.vsix"
          generate_release_notes: true
